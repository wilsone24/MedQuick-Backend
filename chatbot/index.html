<!DOCTYPE html>
<html lang="es">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Med ChatBot</title>
		<link
			rel="stylesheet"
			href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/css/bootstrap.min.css" />
		<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
		<style>
			#response {
				margin-top: 20px;
				padding: 10px;
				min-height: 50px;
			}
			#response h3 {
				color: #333;
				font-size: 1.2em;
			}
			#response strong {
				color: #d9534f;
			}
			#response ul {
				padding-left: 20px;
			}
			#response li {
				margin-bottom: 5px;
			}
			#response div {
				margin-top: 10px;
				padding: 8px 12px;
				border-radius: 8px;
				max-width: 80%;
				word-wrap: break-word;
			}
			#response div:nth-child(odd) {
				background-color: #f1f1f1;
				align-self: flex-start;
			}
			#response div:nth-child(even) {
				background-color: #dff0d8;
				align-self: flex-end;
				text-align: left;
			}
		</style>
	</head>
	<body>
		<div class="container">
			<h2>Med ChatBot</h2>
			<div class="form-group">
				<input
					type="text"
					class="form-control"
					id="userInput"
					placeholder="Ingresa tu pregunta" />
			</div>
			<button class="btn btn-success" onclick="sendMessage()">Preguntar</button>
			<div id="response"></div>
		</div>

		<script>
			let messages = [
				{
					role: 'system',
					content: `Eres un asistente médico servicial y experto que habla español. Preguntas por los síntomas que faltan, nunca inventas respuestas y siempre sugieres medidas preventivas y el especialista adecuado.

Sigue las siguientes reglas para dar tus respuestas:
1. Si falta algún dato, pregunta por él de manera clara y específica 
2. Si la información está completa, genera un JSON con la estructura correcta (guardalo y no lo muestres)
3. No inventar información si el usuario no la proporciona 
4. Mantén la conversación fluida y natural 
5. Si el cliente proporciona información incorrecta, indícale el error y pídele que la corrija 
6. Si el cliente no proporciona la información solicitada, indícale que es necesaria para continuar 
7. Si el cliente proporciona información adicional, agradécele y sigue con el proceso 
8. No mencionar la palabra JSON en las respuestas 
9. Responde solo a cuestiones médicas o dudas concretas como las mencionadas en el contexto (Ej: si te preguntan por el clima, debes responder que no puedes resolver esa inquietud) 
10. Si el cliente solicita información que no está en el contexto, debe decir que no puedes ayudar con esa información y ofrecerle una alternativa. 

Nota: Estamos en 2025, por lo que la fecha y hora deben ser acordes a este año.`,
				}
			];

			async function sendMessage() {
				const input = document.getElementById('userInput').value.trim();
				const responseDiv = document.getElementById('response');
				if (!input) return;

				messages.push({ role: 'user', content: input });

				responseDiv.innerHTML += `<div><strong>Tú:</strong> ${input}</div>`;
				document.getElementById('userInput').value = '';
				responseDiv.innerHTML += `<div><em>Cargando...</em></div>`;
				responseDiv.scrollTop = responseDiv.scrollHeight;

				try {
					const response = await fetch(
						'https://openrouter.ai/api/v1/chat/completions',
						{
							method: 'POST',
							headers: {
								Authorization: 'Bearer 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',
								'HTTP-Referer': 'https://www.sitename.com',
								'X-Title': 'MedApp',
								'Content-Type': 'application/json',
							},
							body: JSON.stringify({
								model: 'deepseek/deepseek-chat-v3-0324:free',
								messages: messages,
							}),
						}
					);

					const data = await response.json();
					const assistantMessage = data.choices?.[0]?.message?.content;

					let finalMessage = assistantMessage?.trim();
					if (!finalMessage) {
						finalMessage = "No he podido generar una respuesta. Por favor asegúrate de brindar todos los síntomas o datos necesarios.";
					}

					messages.push({ role: 'assistant', content: finalMessage });

					const allChats = document.createElement('div');
					allChats.innerHTML = `<div><strong>Asistente:</strong> ${marked.parse(finalMessage)}</div>`;
					responseDiv.lastChild.remove(); // Elimina "Cargando..."
					responseDiv.appendChild(allChats);
					responseDiv.scrollTop = responseDiv.scrollHeight;
				} catch (error) {
					responseDiv.innerHTML += `<div style="color:red;">Error: ${error.message}</div>`;
				}
			}
		</script>
	</body>
</html>
